# Feature 001: ç¹é«”ä¸­æ–‡æ¬„ä½ ID æ”¯æ´ - å¯¦ä½œç¸½çµ

## âœ… å¯¦ä½œå®Œæˆæ—¥æœŸ
**2025-11-18**

---

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

æˆåŠŸå¯¦ä½œç¹é«”ä¸­æ–‡ï¼ˆåŠå…¶ä»– Unicode å­—ç¬¦ï¼‰ä½œç‚º Grist æ¬„ä½ ID çš„æ”¯æ´ã€‚

### ä¿®æ”¹å‰
- `"ç¹é«”ä¸­æ–‡"` â†’ `""` â†’ `"A"` (è‡ªå‹• ID)
- `"ç¹é«”@A"` â†’ `"_A"` â†’ `"A"`
- `"ãƒ¦ãƒ¼ã‚¶ãƒ¼"` â†’ `""` â†’ `"A"`

### ä¿®æ”¹å¾Œ
- `"ç¹é«”ä¸­æ–‡"` â†’ `"ç¹é«”ä¸­æ–‡"` âœ…
- `"ç¹é«”@A"` â†’ `"ç¹é«”_A"` âœ…
- `"ãƒ¦ãƒ¼ã‚¶ãƒ¼å"` â†’ `"ãƒ¦ãƒ¼ã‚¶ãƒ¼å"` âœ…
- `"ì‚¬ìš©ì"` â†’ `"ì‚¬ìš©ì"` âœ…

---

## ğŸ”§ ä¿®æ”¹çš„æª”æ¡ˆ

**ç¸½å…±ä¿®æ”¹ 3 å€‹å±¤ç´šã€4 å€‹æª”æ¡ˆ**:
1. å¾Œç«¯ Python æ¸…ç†é‚è¼¯ (`sandbox/grist/identifiers.py`)
2. å‰ç«¯ TypeScript æ¸…ç†é‚è¼¯ (`app/common/gutil.ts`)
3. è³‡æ–™åº«å±¤ SQL é©—è­‰ (`app/server/lib/SQLiteDB.ts`)
4. æ¸¬è©¦æª”æ¡ˆ (`sandbox/grist/test_gencode.py`)

---

### 1. å¾Œç«¯ Python

#### `sandbox/grist/identifiers.py`
**æ–°å¢å‡½æ•¸**:
- `_is_valid_ident_char(c)` - æª¢æŸ¥å­—ç¬¦æ˜¯å¦ç‚ºæœ‰æ•ˆçš„è­˜åˆ¥ç¬¦å­—ç¬¦ï¼ˆæ”¯æ´ Unicodeï¼‰
- `_is_latin_char(c)` - æª¢æŸ¥å­—ç¬¦æ˜¯å¦ç‚º Latin ç³»å­—ç¬¦ï¼ˆç”¨æ–¼é‡éŸ³ç§»é™¤ï¼‰

**ä¿®æ”¹å‡½æ•¸**:
- `_sanitize_ident(ident, prefix="c", capitalize=False)` - æ ¸å¿ƒæ¸…ç†é‚è¼¯
  - **ç­–ç•¥**: é‡å° Latin å­—ç¬¦ç§»é™¤é‡éŸ³ï¼Œé‡å° CJK å­—ç¬¦ä¿æŒå®Œæ•´
  - ä½¿ç”¨ Unicode é¡åˆ¥æª¢æŸ¥ (`unicodedata.category()`)
  - å° Latin: NFKD åˆ†è§£ â†’ ç§»é™¤çµ„åˆå­—ç¬¦
  - å° CJK: NFC è¦ç¯„åŒ–ä¿æŒå®Œæ•´

**é—œéµæŠ€è¡“**:
```python
def _is_valid_ident_char(c):
    if c == '_':
        return True
    cat = unicodedata.category(c)
    # L* = All letter categories (Lu, Ll, Lt, Lo, Lm)
    # Nd = Decimal number
    return cat[0] == 'L' or cat == 'Nd'

def _is_latin_char(c):
    try:
        name = unicodedata.name(c, '')
        return 'LATIN' in name
    except ValueError:
        code = ord(c)
        return (0x0000 <= code <= 0x024F) or (0x1E00 <= code <= 0x1EFF)
```

---

#### `sandbox/grist/test_gencode.py`
**æ–°å¢æ¸¬è©¦**:
- `test_ident_chinese_support()` - æ¸¬è©¦ç¹ç°¡ä¸­æ–‡ã€æ—¥éŸ“æ–‡æ”¯æ´
  - 15 å€‹æ¸¬è©¦æ¡ˆä¾‹æ¶µè“‹å„ç¨®å ´æ™¯
  - æ··åˆèªè¨€æ¸¬è©¦ (English + ä¸­æ–‡)
  - è¡çªé¿å…æ¸¬è©¦
- `test_ident_fullwidth_characters()` - æ¸¬è©¦å…¨å½¢å­—ç¬¦

**ä¿®æ”¹æ¸¬è©¦**:
- æ›´æ–°è¶Šå—æ–‡æ¸¬è©¦æœŸæœ›å€¼ï¼š`"Báº£ng_Äáº·c_ThÃ¹"` â†’ `"Bang_Äac_Thu"`
  - è¨»é‡‹èªªæ˜ï¼šç¾åœ¨ä¿ç•™ `Ä` (æ”¹é€²çš„ Unicode æ”¯æ´)

---

### 2. å‰ç«¯ TypeScript

#### `app/common/gutil.ts`
**æ–°å¢å‡½æ•¸**:
- `isValidIdentChar(char: string)` - ä½¿ç”¨ Unicode å±¬æ€§è½‰ç¾© (`\p{L}`, `\p{Nd}`)
- `isLatinChar(char: string)` - æª¢æ¸¬ Latin å­—ç¬¦ç¯„åœ

**ä¿®æ”¹å‡½æ•¸**:
- `sanitizeIdent(ident: string, prefix?: string)`
  - æ”¯æ´ Unicode å­—æ¯å’Œæ•¸å­—
  - é‡å°æ¯å€‹å­—ç¬¦æ‡‰ç”¨ä¸åŒç­–ç•¥ï¼ˆLatin vs CJKï¼‰
  - ä½¿ç”¨ `String.normalize()` API

**é—œéµæŠ€è¡“**:
```typescript
function isValidIdentChar(char: string): boolean {
  if (char === '_') { return true; }
  return /^[\p{L}\p{Nd}]$/u.test(char);
}

function isLatinChar(char: string): boolean {
  const code = char.charCodeAt(0);
  if (code <= 0x024F) { return true; }
  if (code >= 0x1E00 && code <= 0x1EFF) { return true; }
  return false;
}
```

---

### 3. è³‡æ–™åº«å±¤ SQL é©—è­‰

#### `app/server/lib/SQLiteDB.ts`
**ä¿®æ”¹å‡½æ•¸**:
- `quoteIdent(ident: string)` (è¡Œ 651)
  - **å•é¡Œ**: åŸæœ¬ä½¿ç”¨ `/^[\w.]+$/` åƒ…æ”¯æ´ ASCII å­—ç¬¦
  - **éŒ¯èª¤è¨Šæ¯**: `"SQL identifier is not valid æˆ‘å€‘"`
  - **è§£æ±º**: æ›´æ–°æ­£å‰‡è¡¨é”å¼æ”¯æ´ Unicode

**ä¿®æ”¹å‰**:
```typescript
export function quoteIdent(ident: string): string {
  assert(/^[\w.]+$/.test(ident), `SQL identifier is not valid: ${ident}`);
  return `"${ident}"`;
}
```

**ä¿®æ”¹å¾Œ**:
```typescript
export function quoteIdent(ident: string): string {
  // Allow Unicode letters, numbers, underscore, and dot
  // \p{L} = Unicode letters (including CJK)
  // \p{Nd} = Decimal numbers
  assert(/^[\p{L}\p{Nd}_.]+$/u.test(ident), `SQL identifier is not valid: ${ident}`);
  return `"${ident}"`;
}
```

**å½±éŸ¿**: é€™æ˜¯ä½¿ç”¨è€…å›å ±éŒ¯èª¤å¾Œç™¼ç¾çš„é—œéµä¿®å¾©ã€‚æ²’æœ‰æ­¤ä¿®å¾©ï¼Œé›–ç„¶å‰å¾Œç«¯éƒ½èƒ½æ­£ç¢ºè™•ç†ä¸­æ–‡ IDï¼Œä½†åœ¨ SQL æŸ¥è©¢å±¤æœƒè¢«æ‹’çµ•ã€‚

---

## ğŸ› ä½¿ç”¨è€…å›å ±å•é¡Œèˆ‡ä¿®å¾©

### å•é¡Œæè¿°
åœ¨å®Œæˆå‰å¾Œç«¯å¯¦ä½œä¸¦é€šéæ‰€æœ‰å–®å…ƒæ¸¬è©¦å¾Œï¼Œä½¿ç”¨è€…å˜—è©¦åœ¨ç€è¦½å™¨ä¸­ä½¿ç”¨ä¸­æ–‡æ¬„ä½åç¨±æ™‚ï¼Œå›å ±äº†éŒ¯èª¤ï¼š

**éŒ¯èª¤è¨Šæ¯**: `"Unexpected error 17:39:50 SQL identifier is not valid æˆ‘å€‘å›å ±å•é¡Œ"`

### æ ¹æœ¬åŸå› 
é›–ç„¶ Python å¾Œç«¯ (`identifiers.py`) å’Œ TypeScript å‰ç«¯ (`gutil.ts`) éƒ½æ­£ç¢ºè™•ç†äº† Unicode å­—ç¬¦ï¼Œä½†åœ¨è³‡æ–™åº«å±¤çš„ SQL è­˜åˆ¥ç¬¦é©—è­‰ (`app/server/lib/SQLiteDB.ts:651`) ä»ä½¿ç”¨åƒ…æ”¯æ´ ASCII çš„æ­£å‰‡è¡¨é”å¼ `/^[\w.]+$/`ã€‚

### ä¿®å¾©éç¨‹
1. **å®šä½éŒ¯èª¤**: ä½¿ç”¨ `grep` æœå°‹éŒ¯èª¤è¨Šæ¯ `"SQL identifier is not valid"`
2. **æ‰¾åˆ°æª”æ¡ˆ**: `app/server/lib/SQLiteDB.ts` ç¬¬ 651 è¡Œçš„ `quoteIdent()` å‡½æ•¸
3. **æ›´æ–°æ­£å‰‡**: å¾ `/^[\w.]+$/` æ”¹ç‚º `/^[\p{L}\p{Nd}_.]+$/u`
4. **é‡æ–°ç·¨è­¯**: åŸ·è¡Œ `npx tsc --build`
5. **é‡å•Ÿä¼ºæœå™¨**: æ–° PID 15490

### é‡è¦æ€§
é€™å€‹ä¿®å¾©è­‰æ˜äº† Unicode æ”¯æ´éœ€è¦åœ¨**ä¸‰å€‹å±¤ç´š**éƒ½æ­£ç¢ºå¯¦ä½œï¼š
1. âœ… Python å¾Œç«¯æ¸…ç†é‚è¼¯
2. âœ… TypeScript å‰ç«¯æ¸…ç†é‚è¼¯
3. âœ… SQL é©—è­‰å±¤ï¼ˆæ­¤æ¬¡ä¿®å¾©ï¼‰

ç¼ºå°‘ä»»ä½•ä¸€å±¤éƒ½æœƒå°è‡´åŠŸèƒ½å¤±æ•—ã€‚

---

## ğŸ§ª æ¸¬è©¦çµæœ

### Python æ¸¬è©¦
**æª”æ¡ˆ**: `test_chinese_support.py`
**çµæœ**: âœ… 15/15 é€šé

æ¸¬è©¦æ¶µè“‹:
- âœ… ç¹é«”ä¸­æ–‡ (4 å€‹æ¸¬è©¦)
- âœ… ç°¡é«”ä¸­æ–‡ (2 å€‹æ¸¬è©¦)
- âœ… æ—¥æ–‡ç‰‡å‡å (3 å€‹æ¸¬è©¦)
- âœ… éŸ“æ–‡ (2 å€‹æ¸¬è©¦)
- âœ… æ··åˆèªè¨€ (2 å€‹æ¸¬è©¦)
- âœ… ç‰¹æ®Šå­—ç¬¦è™•ç† (1 å€‹æ¸¬è©¦)
- âœ… è¡çªé¿å… (1 å€‹æ¸¬è©¦)

### æ­æ´²èªè¨€å›æ­¸æ¸¬è©¦
**æª”æ¡ˆ**: `test_european_accents.py`
**çµæœ**: âœ… 8/8 é€šé

ç¢ºèªç¾æœ‰åŠŸèƒ½æ­£å¸¸:
- âœ… æ³•æ–‡é‡éŸ³ç§»é™¤ (Ã© â†’ e, Ã« â†’ e)
- âœ… åœŸè€³å…¶æ–‡ (ÄŸ â†’ g, Ã§ â†’ c)
- âœ… è¥¿ç­ç‰™æ–‡ (Ã‘ â†’ N)
- âœ… åŒˆç‰™åˆ©æ–‡è¤‡åˆé‡éŸ³
- âœ… è¶Šå—æ–‡ (ä¿ç•™ Äï¼Œç§»é™¤å…¶ä»–é‡éŸ³)

---

## ğŸ”‘ æŠ€è¡“äº®é»

### 1. é›™ç­–ç•¥ Unicode è™•ç†
- **Latin å­—ç¬¦**: ç§»é™¤é‡éŸ³ä½†ä¿ç•™åŸºç¤å­—æ¯
  - `Ã©` â†’ `e` (ç§»é™¤é‡éŸ³)
  - `Ä` â†’ `Ä` (ä¿ç•™ï¼Œå› ç‚ºç„¡æ³•åˆ†è§£)
- **CJK å­—ç¬¦**: å®Œæ•´ä¿ç•™
  - `ä¸­` â†’ `ä¸­`
  - `ã‚¶` â†’ `ã‚¶` (ä¿ç•™æ—¥æ–‡æ¿éŸ³)
  - `ì‚¬` â†’ `ì‚¬` (ä¿ç•™éŸ“æ–‡éŸ³ç¯€)

### 2. Unicode è¦ç¯„åŒ–ç­–ç•¥
**å¾Œç«¯ Python**:
```python
if _is_latin_char(char):
    # åˆ†è§£ â†’ ç§»é™¤çµ„åˆå­—ç¬¦
    decomposed = unicodedata.normalize('NFKD', char)
    filtered = ''.join(c for c in decomposed if not unicodedata.combining(c))
else:
    # è¦ç¯„åŒ–ä¿æŒå®Œæ•´
    char = unicodedata.normalize('NFC', char)
```

**å‰ç«¯ TypeScript**:
```typescript
if (isLatinChar(char)) {
    const normalized = char.normalize('NFD');
    return normalized.replace(/\p{Mn}/gu, '');
} else {
    return char.normalize('NFC');
}
```

### 3. Unicode é¡åˆ¥æª¢æŸ¥
ä½¿ç”¨ `unicodedata.category()` ç²¾ç¢ºè­˜åˆ¥å­—ç¬¦é¡å‹ï¼š
- `L*` - æ‰€æœ‰å­—æ¯é¡åˆ¥ï¼ˆLu, Ll, Lo, Lm, Ltï¼‰
- `Nd` - åé€²ä½æ•¸å­—
- `Mn` - éé–“è·æ¨™è¨˜ï¼ˆçµ„åˆé‡éŸ³ï¼‰

---

## ğŸ“Š æ”¯æ´çš„å­—ç¬¦ç¯„åœ

| ç¯„åœ | åŒ…å«èªè¨€ | è™•ç†æ–¹å¼ |
|------|----------|----------|
| **Basic Latin** (U+0000-U+007F) | English | ç§»é™¤é‡éŸ³ |
| **Latin-1 Supplement** (U+0080-U+00FF) | è¥¿æ­èªè¨€ | ç§»é™¤é‡éŸ³ |
| **Latin Extended A** (U+0100-U+017F) | æ±æ­èªè¨€ | ç§»é™¤é‡éŸ³ |
| **Latin Extended B** (U+0180-U+024F) | éæ´²ã€è¶Šå—æ–‡ | ç§»é™¤é‡éŸ³ |
| **Latin Extended Additional** (U+1E00-U+1EFF) | è¶Šå—æ–‡æ“´å±• | ç§»é™¤é‡éŸ³ |
| **CJK Unified Ideographs** (U+4E00-U+9FFF) | ä¸­æ–‡ã€æ—¥æ–‡æ¼¢å­— | å®Œæ•´ä¿ç•™ |
| **Hiragana** (U+3040-U+309F) | æ—¥æ–‡å¹³å‡å | å®Œæ•´ä¿ç•™ |
| **Katakana** (U+30A0-U+30FF) | æ—¥æ–‡ç‰‡å‡å | å®Œæ•´ä¿ç•™ |
| **Hangul Syllables** (U+AC00-U+D7AF) | éŸ“æ–‡ | å®Œæ•´ä¿ç•™ |
| **Cyrillic** (U+0400-U+04FF) | ä¿„æ–‡ | å®Œæ•´ä¿ç•™ |
| **Greek** (U+0370-U+03FF) | å¸Œè‡˜æ–‡ | å®Œæ•´ä¿ç•™ |

---

## ğŸš€ éƒ¨ç½²ç‹€æ…‹

### å»ºç½®å®Œæˆ
- âœ… TypeScript ç·¨è­¯æˆåŠŸ
- âœ… Webpack æ‰“åŒ…å®Œæˆ (76 ç§’)
- âœ… æ‰€æœ‰æ¸¬è©¦é€šé

### ä¼ºæœå™¨ç‹€æ…‹
- âœ… Grist ä¼ºæœå™¨é‹è¡Œæ–¼ http://localhost:8484
- âœ… PID: 36440 (å·²é©—è­‰ç›£è½ 8484 ç«¯å£)
- âœ… æ—¥èªŒæ­£å¸¸
- âœ… SQL Unicode é©—è­‰å·²ä¿®å¾©
- âœ… æœå‹™å™¨éŸ¿æ‡‰æ­£å¸¸

---

## ğŸ“ å‘å¾Œç›¸å®¹æ€§

### âœ… å®Œå…¨å‘å¾Œç›¸å®¹
1. **ç¾æœ‰æ–‡ä»¶ç„¡éœ€é·ç§»**
   - å·²æœ‰æ¬„ä½çš„ colId ä¿æŒä¸è®Š
   - æ–°è¦å‰‡åƒ…é©ç”¨æ–¼æ–°å»ºæˆ–é‡æ–°å‘½åçš„æ¬„ä½

2. **ç¾æœ‰æ¸¬è©¦é€šé**
   - æ‰€æœ‰æ­æ´²èªè¨€æ¸¬è©¦é€šé
   - åƒ…æ›´æ–°ä¸€å€‹è¶Šå—æ–‡æ¸¬è©¦æœŸæœ›å€¼ï¼ˆæ”¹é€²è¡Œç‚ºï¼‰

3. **API ç›¸å®¹**
   - å‡½æ•¸ç°½åæœªè®Š
   - å›å‚³å€¼é¡å‹æœªè®Š

---

## ğŸ¯ æ¸¬è©¦é©—è­‰æ¸…å–®

### å–®å…ƒæ¸¬è©¦
- âœ… Python: 15/15 é€šé
- âœ… å›æ­¸æ¸¬è©¦: 8/8 é€šé

### å»ºç½®æ¸¬è©¦
- âœ… TypeScript ç·¨è­¯
- âœ… Webpack æ‰“åŒ…
- âœ… ä¼ºæœå™¨å•Ÿå‹•

### æ‰‹å‹•æ¸¬è©¦å»ºè­°
è«‹åœ¨ç€è¦½å™¨ä¸­æ¸¬è©¦ï¼š
1. å»ºç«‹æ–°æ–‡ä»¶
2. æ–°å¢æ¬„ä½ï¼Œåç¨±ç‚º `"ç¹é«”ä¸­æ–‡"`
   - é©—è­‰ colId é¡¯ç¤ºç‚º `"$ç¹é«”ä¸­æ–‡"`
3. æ–°å¢æ¬„ä½ï¼Œåç¨±ç‚º `"æ¸¬è©¦@123"`
   - é©—è­‰ colId é¡¯ç¤ºç‚º `"$æ¸¬è©¦_123"`
4. æ¸¬è©¦å…¬å¼å¼•ç”¨: `$ç¹é«”ä¸­æ–‡`
5. æ¸¬è©¦ä¸åŒèªè¨€:
   - æ—¥æ–‡: `"ãƒ¦ãƒ¼ã‚¶ãƒ¼å"`
   - éŸ“æ–‡: `"ì‚¬ìš©ì"`
   - æ··åˆ: `"Userç”¨æˆ¶"`

---

## ğŸ“š ç›¸é—œæ–‡ä»¶

1. **è¨ˆåŠƒæ–‡ä»¶**: `@docs/features/001-chinese-column-id-support/plan.md`
2. **å¯¦ä½œæª”æ¡ˆ**:
   - **Python å¯¦ç¾**: `sandbox/grist/identifiers.py`
   - **TypeScript å¯¦ç¾**: `app/common/gutil.ts`
   - **SQL é©—è­‰å±¤**: `app/server/lib/SQLiteDB.ts`
3. **æ¸¬è©¦æª”æ¡ˆ**:
   - `test_chinese_support.py` (ç¨ç«‹æ¸¬è©¦)
   - `test_european_accents.py` (å›æ­¸æ¸¬è©¦)
   - `sandbox/grist/test_gencode.py` (æ•´åˆæ¸¬è©¦)

---

## âœ¨ åŠŸèƒ½ç¤ºç¯„

### ç¯„ä¾‹ 1: ç¹é«”ä¸­æ–‡æ¬„ä½
```
è¼¸å…¥æ¬„ä½åç¨±: "ç”¨æˆ¶å§“å"
ç”Ÿæˆ colId: "ç”¨æˆ¶å§“å"
å…¬å¼å¼•ç”¨: $ç”¨æˆ¶å§“å
```

### ç¯„ä¾‹ 2: æ··åˆèªè¨€
```
è¼¸å…¥æ¬„ä½åç¨±: "User@ID"
ç”Ÿæˆ colId: "User_ID"

è¼¸å…¥æ¬„ä½åç¨±: "ç”¨æˆ¶@ID"
ç”Ÿæˆ colId: "ç”¨æˆ¶_ID"
```

### ç¯„ä¾‹ 3: è¡çªè™•ç†
```
ç¬¬ä¸€æ¬„: "æ¸¬è©¦" â†’ colId: "æ¸¬è©¦"
ç¬¬äºŒæ¬„: "æ¸¬è©¦" â†’ colId: "æ¸¬è©¦2"
ç¬¬ä¸‰æ¬„: "æ¸¬è©¦@ç¬¦è™Ÿ" â†’ colId: "æ¸¬è©¦_ç¬¦è™Ÿ"
```

---

## ğŸ‰ ç¸½çµ

æˆåŠŸå¯¦ä½œç¹é«”ä¸­æ–‡åŠæ‰€æœ‰ Unicode å­—ç¬¦æ”¯æ´ï¼ŒåŒæ™‚ï¼š
- âœ… ä¿æŒå‘å¾Œç›¸å®¹
- âœ… æ‰€æœ‰æ¸¬è©¦é€šé
- âœ… å‰å¾Œç«¯é‚è¼¯ä¸€è‡´
- âœ… æ”¯æ´å¤šèªè¨€ï¼ˆä¸­æ—¥éŸ“æ­æ´²ç­‰ï¼‰
- âœ… å®Œæ•´çš„æ¸¬è©¦è¦†è“‹

é€™å€‹åŠŸèƒ½è®“ Grist æˆç‚ºçœŸæ­£çš„åœ‹éš›åŒ–ç”¢å“ï¼Œäºæ´²ç”¨æˆ¶ç¾åœ¨å¯ä»¥ä½¿ç”¨æ¯èªå‘½åæ¬„ä½ï¼ğŸŒ

---

**å¯¦ä½œè€…**: Claude (Anthropic)
**å¯©æ ¸è€…**: Owen Hsu
**ç‹€æ…‹**: âœ… å®Œæˆä¸¦æ¸¬è©¦é€šé
