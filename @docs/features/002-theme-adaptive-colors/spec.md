# Feature 002: 主題自適應顏色系統 - 需求規格

## 📅 文件資訊
- **建立日期**: 2025-11-18
- **功能編號**: 002
- **功能名稱**: Theme-Adaptive Colors (主題自適應顏色)
- **文件類型**: 使用者需求規格
- **狀態**: 草稿 - 待確認

---

## 🎯 功能概述

為 Grist 的欄位顏色和條件格式化顏色配置，新增「主題自適應」功能。當使用者在深色模式和淺色模式之間切換時，所有手動配置的顏色會自動轉換為適合該主題的對應顏色，確保在兩種模式下都保持良好的可讀性和視覺效果。

---

## ❌ 當前問題

### 問題 1: 深色模式配置的顏色在淺色模式不適用

**場景描述**:
1. 使用者在深色模式下配置欄位顏色
   - 例如：選擇淺藍色文字 (#8BB4F7) 配深藍色背景 (#1E3A5F)
   - 在深色模式下效果良好，對比度高且易讀
2. 切換到淺色模式
   - 同樣的淺藍色文字在白色背景上幾乎看不見
   - 深藍色背景在白色介面上顯得過於突兀
   - 整體視覺效果混亂

**實際影響**:
- ❌ 可讀性差：文字顏色與背景對比度不足
- ❌ 視覺不協調：顏色與主題風格不搭配
- ❌ 使用者體驗差：需要在每次切換主題後手動調整所有顏色
- ❌ 工作流中斷：使用者可能因為顏色問題而避免使用深色模式

### 問題 2: 淺色模式配置的顏色在深色模式不適用

**場景描述**:
1. 使用者在淺色模式下配置欄位顏色
   - 例如：選擇深紅色文字 (#8B0000) 配淺粉色背景 (#FFE4E1)
   - 在淺色模式下清晰可讀
2. 切換到深色模式
   - 深紅色文字在深色背景上對比度不足
   - 淺粉色背景顯得刺眼且不協調
   - 整體配色失衡

### 問題 3: 條件格式化規則在不同主題下失效

**場景描述**:
使用者設定條件格式化規則來標示特定狀態：
- 「進行中」→ 黃色背景 (#FFFF00)
- 「已完成」→ 綠色背景 (#00FF00)
- 「已取消」→ 灰色背景 (#888888)

這些顏色在淺色模式下可能合適，但在深色模式下：
- 亮黃色過於刺眼
- 純綠色對比度不足
- 灰色與背景混淆

---

## 👥 使用者需求

### 需求 1: 自動顏色轉換

**使用者故事**:
> 作為一名經常在深色/淺色模式之間切換的使用者，我希望我配置的欄位顏色能夠自動適應當前主題，這樣我就不需要為每個主題維護兩套顏色配置。

**驗收標準**:
- ✅ 當切換到深色模式時，所有配置的顏色自動轉換為深色模式適用的對應顏色
- ✅ 當切換到淺色模式時，所有配置的顏色自動轉換為淺色模式適用的對應顏色
- ✅ 轉換後的顏色保持與原始顏色相同的「色相」（例如紅色系仍然是紅色系）
- ✅ 轉換後的顏色自動調整「明度」和「飽和度」以適應主題
- ✅ 文字與背景始終保持足夠的對比度（WCAG AA 標準）

### 需求 2: 相同色系中的深淺對換

**使用者故事**:
> 作為一名注重視覺設計的使用者，我希望顏色轉換時能保持色系一致性，深色變淺色、淺色變深色，這樣才能保持我原本的設計意圖。

**驗收標準**:
- ✅ 在同一色系內進行轉換（紅色系 → 紅色系，藍色系 → 藍色系）
- ✅ 深色主題中的「淺色」↔ 淺色主題中的「深色」
- ✅ 深色主題中的「深色」↔ 淺色主題中的「淺色」
- ✅ 灰階顏色也能正確轉換（深灰 ↔ 淺灰）
- ✅ 轉換關係是雙向且一致的（來回切換不會產生誤差累積）

### 需求 3: 預覽兩種模式下的效果

**使用者故事**:
> 作為一名正在配置顏色的使用者，我希望在選擇顏色時就能同時看到該顏色在深色和淺色模式下的效果，這樣我可以確保兩種模式下都符合我的需求。

**驗收標準**:
- ✅ 顏色選擇器中顯示「當前主題預覽」和「另一主題預覽」
- ✅ 預覽包含實際的文字和背景效果示例
- ✅ 實時更新：當選擇不同顏色時，兩個預覽同時更新
- ✅ 顯示對比度數值（例如：4.5:1）
- ✅ 如果對比度不足，顯示警告訊息

### 需求 4: 手動覆蓋能力（進階需求）

**使用者故事**:
> 作為一名有特殊需求的使用者，我希望在某些情況下能夠為深色和淺色模式分別設定不同的顏色，而不是使用自動轉換。

**驗收標準**:
- ✅ 預設行為：自動轉換（一個顏色配置自動適應兩種主題）
- ✅ 進階選項：「為每個主題分別設定顏色」勾選框
- ✅ 啟用後，可以獨立設定深色模式和淺色模式的顏色
- ✅ 清楚標示當前正在設定哪個模式的顏色
- ✅ 可以隨時切換回自動模式（會保留當前主題的顏色）

### 需求 5: 現有顏色的遷移

**使用者故事**:
> 作為一名已經配置了許多顏色的現有使用者，我希望升級到新版本後，我的現有顏色配置能自動轉換為新的主題自適應格式，而不會遺失任何設定。

**驗收標準**:
- ✅ 自動檢測現有的顏色配置
- ✅ 將現有顏色視為「當前主題」的顏色
- ✅ 自動生成「另一主題」的對應顏色
- ✅ 轉換過程對使用者透明，無需手動操作
- ✅ 保留原始顏色作為備份（以防轉換不理想）

---

## 🎨 使用場景

### 場景 1: 專案經理配置任務狀態顏色

**背景**:
小王是一名專案經理，使用 Grist 追蹤團隊任務。他白天在辦公室使用淺色模式，晚上在家使用深色模式。

**操作流程**:
1. 小王在淺色模式下設定條件格式化規則：
   - 優先級「高」→ 深紅色背景 + 白色文字
   - 優先級「中」→ 橙色背景 + 深灰色文字
   - 優先級「低」→ 淺灰色背景 + 黑色文字

2. 下班回家後，小王切換到深色模式

3. **期望結果**:
   - 優先級「高」→ 淺紅色背景 + 黑色文字（自動轉換）
   - 優先級「中」→ 深橙色背景 + 淺灰色文字（自動轉換）
   - 優先級「低」→ 深灰色背景 + 白色文字（自動轉換）
   - 所有任務狀態一目了然，無需重新配置

### 場景 2: 財務分析師標記收支資料

**背景**:
小李是財務分析師，需要用顏色標記不同類型的收支。他使用筆記型電腦，根據環境光線在深色/淺色模式間切換。

**操作流程**:
1. 小李在淺色模式下設定欄位顏色：
   - 「收入」欄位 → 深綠色文字 + 淺綠色背景
   - 「支出」欄位 → 深紅色文字 + 淺紅色背景
   - 「餘額」欄位 → 深藍色文字 + 淺藍色背景

2. 到咖啡廳後，環境變暗，小李切換到深色模式

3. **期望結果**:
   - 「收入」欄位 → 淺綠色文字 + 深綠色背景（自動轉換）
   - 「支出」欄位 → 淺紅色文字 + 深紅色背景（自動轉換）
   - 「餘額」欄位 → 淺藍色文字 + 深藍色背景（自動轉換）
   - 財務資料清晰可讀，色彩語意保持一致

### 場景 3: 設計師需要精確控制顏色

**背景**:
小陳是 UI 設計師，對顏色要求嚴格。他需要在深色模式下使用特定的品牌色，但該顏色轉換後不符合品牌規範。

**操作流程**:
1. 小陳發現自動轉換的顏色不是品牌標準色
2. 開啟「為每個主題分別設定顏色」選項
3. 在深色模式下手動設定品牌標準色 #1E90FF
4. 在淺色模式下手動設定另一品牌標準色 #0066CC
5. 切換主題時，系統使用他指定的精確顏色，而非自動轉換

**期望結果**:
- ✅ 系統提供足夠的靈活性
- ✅ 進階使用者可以完全控制顏色
- ✅ 普通使用者仍可使用簡單的自動模式

---

## 🔄 功能行為說明

### 行為 1: 主題切換時的顏色轉換

**觸發時機**:
- 使用者點擊主題切換按鈕
- 系統根據時間自動切換主題
- 系統跟隨作業系統主題設定

**轉換邏輯**:
```
如果顏色配置為「自動模式」（預設）:
  1. 偵測當前要切換到的目標主題（深色/淺色）
  2. 讀取儲存的顏色配置
  3. 如果有對應主題的顏色 → 直接使用
  4. 如果沒有對應主題的顏色 → 執行自動轉換演算法
  5. 套用轉換後的顏色到 UI

如果顏色配置為「手動模式」（進階）:
  1. 讀取該主題專屬的顏色配置
  2. 直接套用，不進行轉換
```

### 行為 2: 顏色配置時的即時預覽

**在顏色選擇器中**:

```
┌─────────────────────────────────────────┐
│ 顏色選擇                                 │
├─────────────────────────────────────────┤
│ 文字顏色: [████] #E00A17                │
│ 背景顏色: [████] #FECBCC                │
│                                         │
│ ┌─────────────────┐ ┌────────────────┐ │
│ │ 淺色模式預覽     │ │ 深色模式預覽    │ │
│ │ [示例文字]       │ │ [示例文字]      │ │
│ │ 對比度: 6.2:1 ✓ │ │ 對比度: 5.8:1 ✓│ │
│ └─────────────────┘ └────────────────┘ │
│                                         │
│ ☐ 為每個主題分別設定顏色（進階）          │
│                                         │
│ [取消] [套用]                            │
└─────────────────────────────────────────┘
```

**行為細節**:
- 左側預覽顯示淺色主題效果
- 右側預覽顯示深色主題效果
- 當前主題的預覽框有高亮邊框
- 對比度數值即時計算並顯示
- 對比度不足時顯示 ⚠️ 警告圖示

### 行為 3: 色彩調色板的分組顯示

**調色板組織**:

目前 Grist 有 64 個預設顏色，組織成 9 組（白黑、紅、棕、橙、黃、綠、淺藍、深藍、紫、粉）。

**建議改進**:
```
每組 4 個顏色分為兩對:
- 索引 0, 1: 淺色主題適用（淺色背景 + 深色文字）
- 索引 2, 3: 深色主題適用（深色背景 + 淺色文字）

視覺提示:
┌────────────────────────────────────┐
│ 紅色系                              │
├────────────────────────────────────┤
│ 淺色主題適用:                        │
│ [淺紅背景] [深紅背景]                │
│                                    │
│ 深色主題適用:                        │
│ [深紅背景] [極深紅背景]              │
└────────────────────────────────────┘
```

---

## 📊 顏色轉換演算法需求

### 基本原則

1. **保持色相 (Hue)**: 紅色系轉換後仍是紅色系
2. **反轉明度 (Lightness)**: 淺色變深色，深色變淺色
3. **調整飽和度 (Saturation)**: 根據主題特性微調
4. **確保對比度 (Contrast)**: 文字與背景符合 WCAG AA 標準（≥ 4.5:1）

### 轉換目標

| 原始主題 | 原始顏色類型 | 目標主題 | 目標顏色類型 | 轉換方式 |
|---------|-------------|---------|------------|---------|
| 淺色 | 深色文字 | 深色 | 淺色文字 | 明度反轉 + 飽和度↑ |
| 淺色 | 淺色背景 | 深色 | 深色背景 | 明度反轉 + 飽和度↓ |
| 深色 | 淺色文字 | 淺色 | 深色文字 | 明度反轉 + 飽和度↓ |
| 深色 | 深色背景 | 淺色 | 淺色背景 | 明度反轉 + 飽和度↑ |

### 特殊情況處理

**灰階顏色** (Saturation ≈ 0):
- 純黑 (#000000) ↔ 純白 (#FFFFFF)
- 深灰 (#888888) ↔ 淺灰 (#CCCCCC)
- 保持相同的「灰度層級」

**高飽和度顏色** (Saturation > 80%):
- 深色模式：降低飽和度避免刺眼 (Saturation = 60-70%)
- 淺色模式：保持高飽和度 (Saturation = 80-90%)

**邊界情況**:
- 已經很淺的顏色 (Lightness > 90%) → 轉為很深 (Lightness < 20%)
- 已經很深的顏色 (Lightness < 10%) → 轉為很淺 (Lightness > 80%)

---

## 🎯 成功指標

### 定量指標

1. **對比度達標率**:
   - 目標：≥ 95% 的轉換後顏色組合符合 WCAG AA 標準（對比度 ≥ 4.5:1）
   - 測量：自動測試所有 64 種調色板顏色的轉換結果

2. **色相保持度**:
   - 目標：轉換前後色相差異 ≤ 15°
   - 測量：使用 HSL 色彩空間計算色相差異

3. **往返一致性**:
   - 目標：淺色 → 深色 → 淺色 後，色差 ΔE < 5
   - 測量：使用 CIEDE2000 色差公式

### 定性指標

1. **使用者滿意度**:
   - 透過問卷調查測量
   - 目標：≥ 80% 使用者認為轉換效果「好」或「很好」

2. **視覺和諧度**:
   - 由設計團隊審查
   - 確保轉換後的顏色符合 Grist 設計系統

3. **減少使用者手動調整**:
   - 監測使用者在主題切換後是否重新配置顏色
   - 目標：手動調整比例下降 ≥ 70%

---

## 🔍 非功能性需求

### 效能需求

- **轉換速度**: 主題切換時，顏色轉換延遲 < 100ms
- **記憶體佔用**: 新增的顏色配置資料 < 1KB per document
- **CPU 使用**: 顏色轉換計算不影響 UI 流暢度

### 相容性需求

- **向後相容**: 現有文件的顏色配置必須完整保留
- **跨瀏覽器**: 支援 Chrome, Firefox, Safari, Edge 最新版本
- **資料遷移**: 升級時自動遷移現有顏色配置

### 可訪問性需求

- **WCAG 2.1 AA**: 所有轉換後的顏色組合符合對比度標準
- **色盲友善**: 不依賴單一顏色傳達訊息
- **高對比模式**: 支援系統的高對比度模式

---

## 🚫 非目標（明確排除）

以下項目**不在**本功能範圍內：

1. ❌ 自動偵測「最佳顏色」並建議使用者
2. ❌ AI 驅動的顏色配置建議系統
3. ❌ 匯入/匯出顏色主題配置檔
4. ❌ 自訂主題（超出深色/淺色的其他主題）
5. ❌ 圖片或圖示的主題自適應
6. ❌ 第三方套件的顏色整合

---

## 📝 使用者介面需求

### UI 變更 1: 顏色選擇器增強

**位置**: 右側面板 → 欄位配置 → 顏色

**新增元素**:
1. 「雙主題預覽」區塊
   - 並排顯示淺色和深色預覽
   - 實時更新
   - 顯示對比度數值

2. 「進階設定」展開區
   - 「為每個主題分別設定顏色」勾選框
   - 主題切換按鈕（在手動模式下）

3. 「對比度警告」提示
   - 對比度不足時自動顯示
   - 提供建議修正方案

### UI 變更 2: 主題切換時的視覺回饋

**行為**:
- 主題切換時，顯示短暫的載入動畫（避免突兀）
- 淡入淡出過渡效果（300ms）
- 如果有顏色轉換，顯示「顏色已自動調整」的非侵入式提示

### UI 變更 3: 條件格式化規則編輯器

**新增功能**:
- 規則預覽區顯示「雙主題效果」
- 每條規則旁顯示小圖示，標示是「自動模式」或「手動模式」
- 批次轉換選項：「將所有規則轉換為自動模式」

---

## ⚠️ 潛在風險與考量

### 風險 1: 轉換演算法的主觀性

**問題**: 顏色美感具有主觀性，自動轉換可能不符合所有使用者的期望

**緩解措施**:
- 提供手動覆蓋選項
- 開放轉換參數供進階使用者調整
- 充分的使用者測試和回饋收集

### 風險 2: 現有顏色配置的遷移

**問題**: 自動遷移可能產生不理想的轉換結果

**緩解措施**:
- 保留原始顏色配置作為備份
- 提供「還原」功能
- 在升級說明中提醒使用者檢查顏色配置

### 風險 3: 效能影響

**問題**: 即時計算顏色轉換可能影響 UI 效能

**緩解措施**:
- 使用快取機制避免重複計算
- 轉換演算法最佳化
- 懶載入：僅在需要時才計算轉換

### 風險 4: 品牌色和精確色彩需求

**問題**: 某些使用者需要精確的品牌色，不接受任何轉換

**緩解措施**:
- 提供完全的手動控制選項
- 清楚標示自動/手動模式
- 允許鎖定特定顏色不轉換

---

## 🔄 與現有功能的整合

### 整合點 1: 主題系統

**現有**: `app/client/ui2018/theme.ts` 和 `ThemeConfig.ts`

**整合方式**:
- 監聽主題切換事件
- 在主題切換時觸發顏色轉換
- 整合到現有的 Observable 反應式系統

### 整合點 2: 顏色選擇器

**現有**: `app/client/ui2018/ColorSelect.ts` 和 `ColorPalette.ts`

**整合方式**:
- 擴展 `ColorOption` 介面支援主題對應色
- 在 `buildColorPicker()` 中新增預覽區
- 整合對比度計算工具

### 整合點 3: 樣式儲存

**現有**: `app/client/models/Styles.ts`

**整合方式**:
- 擴展 `Style` 和 `HeaderStyle` 介面
- 新增 `colorMode` 欄位（'auto' | 'manual'）
- 新增 `lightThemeColor` 和 `darkThemeColor` 欄位（手動模式使用）

### 整合點 4: 條件格式化

**現有**: `app/client/widgets/ConditionalStyle.ts`

**整合方式**:
- 更新 `rulesStyles` 儲存格式
- 在規則評估時套用主題轉換
- 更新規則編輯器 UI

---

## 🎓 參考資料

### 色彩理論

1. **HSL 色彩空間**: Hue (色相), Saturation (飽和度), Lightness (明度)
2. **WCAG 2.1 對比度標準**:
   - AA 級別：≥ 4.5:1 (普通文字)
   - AAA 級別：≥ 7:1 (普通文字)
3. **CIEDE2000**: 色差計算公式

### 業界實踐

1. **Material Design**:
   - Light/Dark theme color mapping
   - Elevation and surfaces

2. **Apple Human Interface Guidelines**:
   - Dynamic colors in light and dark modes
   - Color contrast requirements

3. **GitHub**:
   - Primer design system theme colors
   - Automatic color adaptation

### 技術參考

1. **CSS Color Module Level 4**:
   - `color-contrast()` function
   - `lch()` and `oklch()` color spaces

2. **Web Content Accessibility Guidelines (WCAG) 2.1**

---

## ✅ 驗收標準總結

功能完成需要滿足以下所有標準：

### 基本功能
- [ ] 主題切換時，所有顏色配置自動轉換
- [ ] 轉換保持色相一致
- [ ] 轉換後的對比度符合 WCAG AA 標準
- [ ] 支援手動為每個主題設定顏色

### 使用者介面
- [ ] 顏色選擇器顯示雙主題預覽
- [ ] 即時顯示對比度數值
- [ ] 對比度不足時顯示警告
- [ ] 提供自動/手動模式切換

### 資料遷移
- [ ] 現有顏色配置自動遷移
- [ ] 遷移過程不遺失資料
- [ ] 提供還原機制

### 效能與相容性
- [ ] 主題切換延遲 < 100ms
- [ ] 支援所有主流瀏覽器
- [ ] 向後相容現有文件

### 測試與品質
- [ ] 單元測試覆蓋率 ≥ 80%
- [ ] 所有調色板顏色的轉換測試通過
- [ ] 使用者接受度測試 ≥ 80% 滿意度

---

## 📞 下一步

請審閱本規格文件並提供回饋：

1. **功能範圍**: 是否符合您的預期？是否有遺漏或需要調整的部分？
2. **使用場景**: 是否涵蓋您的實際使用情境？
3. **UI 設計**: 「雙主題預覽」的設計是否符合需求？
4. **顏色轉換邏輯**: 「保持色相、反轉明度」的策略是否合適？
5. **手動覆蓋功能**: 是否需要更多的進階控制選項？

確認規格後，我將建立詳細的技術設計文件和實作計劃。

---

**文件版本**: 1.0
**最後更新**: 2025-11-18
**審核狀態**: ⏳ 待使用者確認
